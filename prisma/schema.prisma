generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserStatus {
  ACTIVE
  DELETED
}

enum Role {
  ADMIN
  MEMBER
}

enum EndpointType {
  MOCK
  EXTERNAL
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
}

enum RunStatus {
  CREATED
  UPLOADING
  UPLOADED
  PARSING
  READY_FOR_JUDGING
  JUDGING
  COMPLETED
  COMPLETED_LOW_CONFIDENCE
  FAILED
  PENDING
  PROCESSING
}

enum EvaluationStatus {
  PENDING
  COMPLETED
  FAILED
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  passwordHash String
  name         String?
  status       UserStatus @default(ACTIVE)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?

  memberships       Membership[]
  sessions          Session[]
  apiTokens         ApiToken[]
  tools             Tool[]              @relation("UserTools")
  auditLogs         AuditLog[]
  EmailVerification EmailVerification[]
  PasswordReset     PasswordReset[]

  ownedProjects    Project[]    @relation("UserProjectsOwned")
  triggeredRuns    AgentRun[]   @relation("UserRunsTriggered")
  uploadedLogfiles RunLogfile[] @relation("UserRunLogfiles")

  @@index([status])
}

model Session {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?
  ip        String?   @db.Inet
  userAgent String?

  @@index([userId])
  @@index([expiresAt])
}

model ApiToken {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  hashedToken String    @unique
  scopes      String[]  @default([])
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  revokedAt   DateTime?

  @@index([userId])
}

model EmailVerification {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  projects    Project[]
  tools       Tool[]
  testSuites  TestSuite[]

  @@unique([name])
}

model Membership {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  role        Role     @default(MEMBER)
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId])
}

model Project {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  description String?
  createdById String?
  isArchived  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdBy   User?          @relation("UserProjectsOwned", fields: [createdById], references: [id], onDelete: SetNull)
  runs        AgentRun[]
  evaluations RunEvaluation[]
  logfiles    RunLogfile[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([createdById])
  @@index([isArchived])
}

model Tool {
  id          String   @id @default(cuid())
  workspaceId String
  ownerId     String?
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  owner     User?         @relation(name: "UserTools", fields: [ownerId], references: [id], onDelete: SetNull)
  versions  ToolVersion[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([ownerId])
}

model ToolVersion {
  id           String       @id @default(cuid())
  toolId       String
  version      String       @default("1.0.0")
  endpointType EndpointType @default(MOCK)
  baseUrl      String?
  inputSchema  Json
  outputSchema Json
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())

  tool          Tool           @relation(fields: [toolId], references: [id], onDelete: Cascade)
  mockEndpoints MockEndpoint[]

  @@unique([toolId, version])
  @@index([toolId, isActive])
}

model MockEndpoint {
  id              String     @id @default(cuid())
  toolVersionId   String
  method          HttpMethod @default(GET)
  path            String
  statusCode      Int        @default(200)
  latencyMs       Int        @default(100)
  errorRatePct    Float      @default(0)
  exampleRequest  Json?
  exampleResponse Json?

  toolVersion ToolVersion @relation(fields: [toolVersionId], references: [id], onDelete: Cascade)

  @@unique([toolVersionId, method, path])
  @@index([toolVersionId])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  actorEmail String?
  action     String
  targetType String
  targetId   String?
  metadata   Json?
  ip         String?  @db.Inet
  userAgent  String?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([action])
}

model TestSuite {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  corePrompt  String   @db.Text

  toolIds     Json     @default("[]")
  config      Json?
  variables   Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  runs        AgentRun[]
  evaluations RunEvaluation[]

  @@index([workspaceId])
}

model AgentRun {
  id            String      @id @default(cuid())
  projectId     String
  testSuiteId   String?
  triggeredById String?
  status        RunStatus   @default(CREATED)
  taskName      String?
  taskDefinition Json?
  inputPayload  Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  startedAt     DateTime?
  completedAt   DateTime?

  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testSuite   TestSuite? @relation(fields: [testSuiteId], references: [id], onDelete: SetNull)
  triggeredBy User?      @relation("UserRunsTriggered", fields: [triggeredById], references: [id], onDelete: SetNull)

  logfiles         RunLogfile[]
  evaluations      RunEvaluation[]
  runEvents        RunEvent[]
  traceSummary     RunTraceSummary?
  metrics          RunMetrics?
  ruleFlags        RunRuleFlag[]
  judgePacket      RunJudgePacket?

  @@index([projectId])
  @@index([testSuiteId])
  @@index([triggeredById])
  @@index([status])
  @@index([createdAt])
}

model RunLogfile {
  id           String   @id @default(cuid())
  runId        String
  projectId    String
  uploadedById String?
  storageKey   String
  url          String
  sizeBytes    Int
  checksum     String?
  contentType  String?
  createdAt    DateTime @default(now())
  metadata     Json?

  run        AgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy User?    @relation("UserRunLogfiles", fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([runId])
  @@index([projectId])
  @@index([uploadedById])
}

model RunEvaluation {
  id           String           @id @default(cuid())
  runId        String
  projectId    String
  testSuiteId  String?
  status       EvaluationStatus @default(PENDING)
  totalScore   Float?
  metricBreakdown Json?
  summary      String?          @db.Text
  geminiJudgement Json?
  groqJudgement   Json?
  finalScorecard  Json?
  confidence      Float?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  run       AgentRun  @relation(fields: [runId], references: [id], onDelete: Cascade)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testSuite TestSuite? @relation(fields: [testSuiteId], references: [id], onDelete: SetNull)

  @@index([runId])
  @@index([projectId])
  @@index([testSuiteId])
  @@index([status])
  @@index([createdAt])
}

model RunEvent {
  id          String   @id @default(cuid())
  runId       String
  eventType   String
  eventData   Json
  timestamp   DateTime?
  sequence    Int
  createdAt   DateTime @default(now())

  run AgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([runId, sequence])
  @@index([eventType])
}

model RunTraceSummary {
  id              String   @id @default(cuid())
  runId           String   @unique
  normalizedTrace String   @db.Text
  parserVersion   String
  parseReport     Json
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  run AgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
}

model RunMetrics {
  id            String   @id @default(cuid())
  runId         String   @unique
  totalSteps    Int
  totalToolCalls Int
  totalErrors   Int
  totalRetries  Int
  totalDurationMs Int?
  parserVersion String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  run AgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
}

model RunRuleFlag {
  id            String   @id @default(cuid())
  runId         String
  flagType      String
  severity      String
  message       String
  evidenceEventIds String[] @default([])
  metadata      Json?
  createdAt     DateTime @default(now())

  run AgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([flagType])
  @@index([severity])
}

model RunJudgePacket {
  id            String   @id @default(cuid())
  runId         String   @unique
  packet        String   @db.Text
  packetSizeBytes Int
  parserVersion String
  rubricVersion String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  run AgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
}
